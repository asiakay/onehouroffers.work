name: Setup Cloudflare Resources

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  setup-cloudflare:
    runs-on: ubuntu-latest
    name: Create Cloudflare Resources
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Authenticate Wrangler
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Authenticated with Cloudflare"
          wrangler whoami

      - name: Create D1 Database
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Creating D1 database..."
          wrangler d1 create onehouroffers-db --json > d1-output.json
          cat d1-output.json
          
          # Extract database ID
          DB_ID=$(cat d1-output.json | grep -o '"database_id":"[^"]*' | cut -d'"' -f4)
          echo "Database ID: $DB_ID"
          echo "D1_DATABASE_ID=$DB_ID" >> $GITHUB_ENV
          
          # Save to output
          echo "## D1 Database Created âœ…" >> $GITHUB_STEP_SUMMARY
          echo "Database Name: onehouroffers-db" >> $GITHUB_STEP_SUMMARY
          echo "Database ID: \`$DB_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Initialize D1 Database Schema
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Initializing database schema..."
          wrangler d1 execute onehouroffers-db --file=./database/schema-d1-clean.sql
          echo "âœ… Schema initialized successfully"
          
          echo "## Database Schema Initialized âœ…" >> $GITHUB_STEP_SUMMARY
          echo "Tables created: customers, bookings, payments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create KV Namespace
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Creating KV namespace..."
          wrangler kv:namespace create "BOOKINGS_CACHE" --preview false > kv-output.txt
          cat kv-output.txt
          
          # Extract KV namespace ID
          KV_ID=$(cat kv-output.txt | grep -o 'id = "[^"]*' | cut -d'"' -f2)
          echo "KV Namespace ID: $KV_ID"
          echo "KV_NAMESPACE_ID=$KV_ID" >> $GITHUB_ENV
          
          # Save to output
          echo "## KV Namespace Created âœ…" >> $GITHUB_STEP_SUMMARY
          echo "Namespace Name: BOOKINGS_CACHE" >> $GITHUB_STEP_SUMMARY
          echo "Namespace ID: \`$KV_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Create R2 Bucket
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Creating R2 bucket..."
          wrangler r2 bucket create onehouroffers-files
          echo "âœ… R2 bucket created successfully"
          
          echo "## R2 Bucket Created âœ…" >> $GITHUB_STEP_SUMMARY
          echo "Bucket Name: onehouroffers-files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Update wrangler.toml with IDs
        run: |
          echo "Updating wrangler.toml with resource IDs..."
          
          # Update D1 Database ID
          sed -i "s/YOUR_D1_DATABASE_ID/${{ env.D1_DATABASE_ID }}/g" worker/wrangler.toml
          
          # Update KV Namespace ID
          sed -i "s/YOUR_KV_NAMESPACE_ID/${{ env.KV_NAMESPACE_ID }}/g" worker/wrangler.toml
          
          # Update Account ID
          sed -i "s/YOUR_CLOUDFLARE_ACCOUNT_ID/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/g" worker/wrangler.toml
          
          echo "âœ… wrangler.toml updated"

      - name: Commit updated wrangler.toml
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add worker/wrangler.toml
          git commit -m "chore: update wrangler.toml with Cloudflare resource IDs" || echo "No changes to commit"
          git push || echo "Nothing to push"

      - name: Setup Complete Summary
        run: |
          echo "# ðŸŽ‰ Cloudflare Setup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All resources have been created successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… D1 Database created and initialized" >> $GITHUB_STEP_SUMMARY
          echo "2. âœ… KV Namespace created" >> $GITHUB_STEP_SUMMARY
          echo "3. âœ… R2 Bucket created" >> $GITHUB_STEP_SUMMARY
          echo "4. âœ… wrangler.toml updated with IDs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Ready to Deploy!" >> $GITHUB_STEP_SUMMARY
          echo "Your next push to main will automatically deploy the Worker and Frontend." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Resource IDs:" >> $GITHUB_STEP_SUMMARY
          echo "- D1 Database ID: \`${{ env.D1_DATABASE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- KV Namespace ID: \`${{ env.KV_NAMESPACE_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- R2 Bucket: onehouroffers-files" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "# âŒ Setup Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Common issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid CLOUDFLARE_API_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid CLOUDFLARE_ACCOUNT_ID" >> $GITHUB_STEP_SUMMARY
          echo "- Insufficient permissions on API token" >> $GITHUB_STEP_SUMMARY
